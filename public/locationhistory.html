<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>My Car Location</title>
  <meta name="description" content="My Car Location">
  <meta name="author" content="SitePoint">

  <link rel="stylesheet" href= "https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
   integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
   crossorigin=""/>  
   <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
   integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
   crossorigin=""></script>
   <script src="http://maxcdn.bootstrapcdn.com/bottstrap/4.3.1/js/bootstrap.min.js"></script>
   <style>
        
       #mapid { height: 550px; }
       #mapid { width: 100%; }
     

       p{
        font-size: 20px;  /*tamaÃ±o*/
        
        }

        table { width: 100%; }

   </style>

    <style type="text/css">
        .tg  {border-collapse:collapse;border-spacing:0;}
        .tg td{border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;
        overflow:hidden;padding:10px 5px;word-break:normal;}
        .tg th{border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;
        font-weight:normal;overflow:hidden;padding:10px 5px;word-break:normal;}
        .tg .tg-0lax{text-align:left;vertical-align:top}
    </style>

</head>

<body>
    <nav class="navbar navbar-dark bg dark">
      <div class="container">
        <h1 style="color: green">MY CAR LOCATION</h1> 
        <div class="well">Sistema de Geolocazación móvil</div> 
      </div>
    </nav>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <a class="navbar-brand" href="#">Navbar</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
      
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav mr-auto">
            <li class="nav-item active">
              <a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">Link</a>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Dropdown
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                <a class="dropdown-item" href="#">Action</a>
                <a class="dropdown-item" href="#">Another action</a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item" href="#">Something else here</a>
              </div>
            </li>
            <li class="nav-item">
              <a class="nav-link disabled" href="#">Disabled</a>
            </li>
          </ul>
          <form class="form-inline my-2 my-lg-0">
            <input class="form-control mr-sm-2" type="search" placeholder="Search" aria-label="Search">
            <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
          </form>
        </div>
      </nav>
    
    <div id="mapid"></div>

    <div id="table" style="margin-top:30px"></div>
    <table class="table">
        <thead class="thead-dark">
          <tr>
            <th scope="col">Placa</th>
            <th scope="col">Latitud</th>
            <th scope="col">Longitud</th>
            <th scope="col">Fecha</th>
            <th scope="col">Hora</th>
          </tr>
        </thead>

        <tbody>
          <tr>
            <th scope="row" id="plate1">EFE-070</th>
            <td class="tg-0lax" id="lat">10.992390086364746</td>
            <td class="tg-0lax" id="lon">-74.80256652832031</td>
            <td class="tg-0lax" id="fec">2021-03-09</td>
            <td class="tg-0lax" id="hor">19:05:11</td>
          </tr>
          <tr>
            <th scope="row" id="plate2">ABC-425</th>
            <td class="tg-0lax" id="latitud">10.992390086364746</td>
            <td class="tg-0lax" id="longitud">-74.80256652832031</td>
            <td class="tg-0lax" id="fecha">2021-03-09</td>
            <td class="tg-0lax" id="hora">19:05:11</td>
          </tr>
          <tr>
            <th scope="row" id="plate3">BTE-425</th>
            <td class="tg-0lax" id="latitude">10.992390086364746</td>
            <td class="tg-0lax" id="longitude">-74.80256652832031</td>
            <td class="tg-0lax" id="date">2021-03-09</td>
            <td class="tg-0lax" id="time">2021-03-09</td>
          </tr>
        </tbody>
    </table>

    <script>

        let boundsSet = false; 

        const myMap = L.map('mapid').setView([10.9578, -74.792], 12);

        const attribution = '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors';

        const tileUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'

        const tiles = L.tileLayer(tileUrl,  { attribution }).addTo(myMap);
        
        const greenIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        var redIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        const marker_1 = L.marker([0, 0]).addTo(myMap);
        const marker_2 = L.marker([0, 0], {icon: greenIcon}).addTo(myMap);
        const marker_3 = L.marker([0, 0], {icon: redIcon}).addTo(myMap);

        getData();

        setInterval(getData, 5000);

        async function getData() {

            const response = await fetch('http://34.221.26.86:50001/vehicles');
            const jsonData = await response.json();
            
            vehicles = jsonData;
            console.log(vehicles);            
            updateMarkersAndText(vehicles);
        }

        function updateMarkersAndText(data) {
        
            if (!boundsSet) {
              const group = new L.featureGroup([marker_1, marker_2, marker_3]);
              myMap.fitBounds(group.getBounds().pad(0.5));
              boundsSet = true;
            }

            for (var i = 0; i < 3; i++) {
              if (vehicles[i].id == "efee70") {
                document.getElementById('lat').innerHTML = vehicles[i].latitude;
                document.getElementById('lon').innerHTML = vehicles[i].longitude;
                document.getElementById('fec').innerHTML = vehicles[i].date;
                document.getElementById('hor').innerHTML = vehicles[i].time;
                marker_1.setLatLng([vehicles[i].latitude, vehicles[i].longitude]);
                marker_1.bindPopup("Placa: EFE-070").openPopup();
              }
              if (vehicles[i].id == "b7ea25") {
                document.getElementById('latitud').innerHTML = vehicles[i].latitude;
                document.getElementById('longitud').innerHTML = vehicles[i].longitude;
                document.getElementById('fecha').innerHTML = vehicles[i].date;
                document.getElementById('hora').textContent = vehicles[i].time;
                marker_2.setLatLng([vehicles[i].latitude, vehicles[i].longitude]);
                marker_2.bindPopup("Placa: ABC-425").openPopup();
              } 
              if (vehicles[i].id == "487a8d") {
                document.getElementById('latitude').textContent = vehicles[i].latitude;
                document.getElementById('longitude').textContent = vehicles[i].longitude;
                document.getElementById('date').textContent = vehicles[i].date;
                document.getElementById('time').textContent = vehicles[i].time;
                marker_3.setLatLng([vehicles[i].latitude, vehicles[i].longitude]);
                marker_3.bindPopup("Placa: BTE-425").openPopup();
              }
            }
        }

        function splitIncomingData(data) {

            const dataLines = data.split("\n")
            const dataSplit = ["", "", ""]
            for (const lines in dataLines) {
                dataSplit[lines] = dataLines[lines].split(" ");
            }
            return dataSplit;

        }
        
    </script>
</body>
</html>
