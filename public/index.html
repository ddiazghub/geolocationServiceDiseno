<!doctype html>

<html lang="en">

<!--Encabezado HTML-->
<head>
  <meta charset="utf-8">

  <title>The HTML5 Herald</title>
  <meta name="description" content="The HTML5 Herald">
  <meta name="author" content="SitePoint">

   <!--Se importa la API Leaflet--> 
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
   integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
   crossorigin=""/>

   <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
   integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
   crossorigin=""></script>

    <!--Se ajustan dimensiones del mapa-->
   <style>
        
       #mapid { height: 550px; }
       #mapid { width: 100%; }
     

       p{
        font-size: 20px;  /*tamaÃ±o*/
        
        }

        table { width: 100%; }

   </style>

    <!--Estilo de la tabla-->
    <style type="text/css">
        .tg  {border-collapse:collapse;border-spacing:0;}
        .tg td{border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;
        overflow:hidden;padding:10px 5px;word-break:normal;}
        .tg th{border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;
        font-weight:normal;overflow:hidden;padding:10px 5px;word-break:normal;}
        .tg .tg-0lax{text-align:left;vertical-align:top}
    </style>

</head>

<body>

<header> 
  <h1>MY CAR LOCATION<h1>
  <h2>Servicio de Geolocalización Móvil<h2>
</header>

    <!--Formato del cuerpo de la página-->
    <hr>
    <div id="mapid"></div>

    <div id="table" style="margin-top:30px"></div>
    <table class="tg">
        <thead>
          <tr>
            <th class="tg-0lax">Placa</th>
            <th class="tg-0lax">Latitud</th>
            <th class="tg-0lax">Longitud</th>
            <th class="tg-0lax">Fecha</th>
            <th class="tg-0lax">Hora</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="tg-0lax" id="plate1">EFE-070</td>
            <td class="tg-0lax" id="lat">10.992390086364746</td>
            <td class="tg-0lax" id="lon">-74.80256652832031</td>
            <td class="tg-0lax" id="fec">2021-03-09</td>
            <td class="tg-0lax" id="hor">19:05:11</td>
          </tr>
          <tr>
            <td class="tg-0lax" id="plate2">ABC-425</td>
            <td class="tg-0lax" id="latitud">10.992390086364746</td>
            <td class="tg-0lax" id="longitud">-74.80256652832031</td>
            <td class="tg-0lax" id="fecha">2021-03-09</td>
            <td class="tg-0lax" id="hora">19:05:11</td>
          </tr>
          <tr>
            <td class="tg-0lax" id="plate3">BTE-425</td>
            <td class="tg-0lax" id="latitude">10.992390086364746<</td>
            <td class="tg-0lax" id="longitude">-74.80256652832031</td>
            <td class="tg-0lax" id="date">2021-03-09</td>
            <td class="tg-0lax" id="time">2021-03-09</td>
          </tr>
        </tbody>
    </table>

    <script>

        //Se crea una variable ara ajustar los límites del mapa solo una vez
        let boundsSet = false;

        //Se crea el bloque del mapa
        const myMap = L.map('mapid').setView([10.9578, -74.792], 12);

        //Se dan créditos a OpenStreetMap por las tiles del mapa
        const attribution = '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors';

        //Se escribe el URL del servidor que contiene las tiles
        const tileUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'

        //Se añaden las tiles al cuadro del mapa
        const tiles = L.tileLayer(tileUrl,  { attribution }).addTo(myMap);
        
        const greenIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        var redIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        //Se añaden marcadores de posición al mapa
        const marker_1 = L.marker([0, 0]).addTo(myMap);
        const marker_2 = L.marker([0, 0], {icon: greenIcon}).addTo(myMap);
        const marker_3 = L.marker([0, 0], {icon: redIcon}).addTo(myMap);

        //Se llama la función para actualizar datos cada 5 segundos
        getData();

        setInterval(getData, 5000);

        async function getData() {

            //Se ejecuta un fetch para solicitar acceder al contenido del archivo de texto
            const response = await fetch('loadData.txt');
            //Se espera a obtener los contenidos del .txt
            let data = await response.text();
            
            //Se separa la string obtenida del .txt por líneas y por palabras
            data = splitIncomingData(data);

            //Se actualizan los marcadores de posición con la nueva información obtenida, se actualiza la tabla también
            updateMarkersAndText(data);

        }

        //Se actualizan los marcadores de posición con la nueva información obtenida, se actualiza la tabla también
        function updateMarkersAndText(data) {
            marker_1.setLatLng([data[0][1], data[0][2]]);
            marker_2.setLatLng([data[1][1], data[1][2]]);
            marker_3.setLatLng([data[2][1], data[2][2]]);
            
            marker_1.bindPopup("Placa: EFE-070").openPopup();
            marker_2.bindPopup("Placa: ABC-425").openPopup();
            marker_3.bindPopup("Placa: BTE-425").openPopup();

            if (!boundsSet) {
                const group = new L.featureGroup([marker_1, marker_2, marker_3]);
                myMap.fitBounds(group.getBounds().pad(0.5));
                boundsSet = true;
            }

            document.getElementById('lat').innerHTML = data[0][1];
            document.getElementById('lon').innerHTML = data[0][2];
            document.getElementById('fec').innerHTML = data[0][3];
            document.getElementById('hor').innerHTML = data[0][4];

            document.getElementById('latitud').innerHTML = data[1][1];
            document.getElementById('longitud').innerHTML = data[1][2];
            document.getElementById('fecha').innerHTML = data[1][3];
            document.getElementById('hora').textContent = data[1][4];

            document.getElementById('latitude').textContent = data[2][1];
            document.getElementById('longitude').textContent = data[2][2];
            document.getElementById('date').textContent = data[2][3];
            document.getElementById('time').textContent = data[2][4];
        }

        function splitIncomingData(data) {

            //Se separa la información por líneas
            const dataLines = data.split("\n")
            const dataSplit = ["", "", ""]
            for (const lines in dataLines) {
                //Se separa la información por espacios
                dataSplit[lines] = dataLines[lines].split(" ");
            }
            return dataSplit;

        }
        
    </script>
</body>
</html>